{% extends 'base.html' %}
{% block title %}Subscriptions{% endblock %}
{% block content %}
<div class="content-section">
    <div class="section-header">
        <i class="fas fa-microchip"></i>
        <div>
            <h3>Hardware ID Reset</h3>
            <p class="section-desc">Available every 2 weeks</p>
        </div>
    </div>
    <form method="POST" action="{{ url_for('hwid_reset') }}" class="hwid-form">
        <input type="text" name="reason" placeholder="(Optional) Reason for reset" class="input-field">
        <button type="submit" class="btn btn-secondary">
            <i class="fas fa-sync-alt"></i> Reset
        </button>
    </form>
</div>

<div class="content-section">
    <div class="section-header">
        <i class="fas fa-key"></i>
        <div>
            <h3>Key Activation</h3>
            <p class="section-desc">Activate your key.</p>
        </div>
    </div>
    <form method="POST" action="{{ url_for('activate_key') }}" class="key-form">
        <input type="text" name="key" placeholder="Enter your key code" class="input-field">
        <button type="submit" class="btn btn-secondary">
            <i class="fas fa-key"></i> Activate
        </button>
    </form>
</div>

{% if user.subscriptions %}
<div class="content-section">
    <div class="section-header">
        <i class="fas fa-check-circle"></i>
        <div>
            <h3>Your Active Subscriptions</h3>
            <p class="section-desc">Your current active products</p>
        </div>
    </div>
    <div class="subscriptions-list">
        {% for sub in user.subscriptions %}
        <div class="subscription-item {% if sub.is_active %}sub-active{% endif %}">
            {% set cheat = cheats|selectattr('id', 'eq', sub.cheat_id)|first %}
            {% if cheat and cheat.icon_type == 'image' and cheat.icon %}
            <img src="{{ cheat.icon }}" class="sub-icon-img" alt="">
            {% else %}
            <div class="sub-icon">{{ sub.game[0] }}</div>
            {% endif %}
            <div class="sub-info">
                <span class="sub-game">[{{ sub.game }}]</span>
                <span class="sub-name">{{ sub.cheat_name }}</span>
                <span class="sub-status">
                    {% if sub.is_active %}
                    <i class="fas fa-check"></i> Active - {{ sub.days_left }} days left
                    {% else %}
                    <i class="fas fa-times"></i> Expired
                    {% endif %}
                </span>
            </div>
            <div class="sub-expires">
                <small>Expires: {{ sub.expires }}</small>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="content-section">
    <div class="section-header">
        <i class="fas fa-shopping-cart"></i>
        <div>
            <h3>Available Products</h3>
            <p class="section-desc">Feel the excellence in a few clicks</p>
        </div>
    </div>
    <div class="subscriptions-list">
        {% for cheat in cheats %}
        {% if cheat.active %}
        <div class="subscription-item">
            {% if cheat.icon_type == 'image' and cheat.icon %}
            <img src="{{ cheat.icon }}" class="sub-icon-img" alt="">
            {% else %}
            <div class="sub-icon">{{ cheat.icon or cheat.name[0] }}</div>
            {% endif %}
            <div class="sub-info">
                <span class="sub-game">[{{ cheat.game }}]</span>
                <span class="sub-name">{{ cheat.name }}</span>
                <span class="sub-price">
                    {% if cheat.price > 0 %}
                    ${{ cheat.price }}/month
                    <span class="lc-price">â‰ˆ {{ (cheat.price * site_settings.coin_rate)|int }} LC</span>
                    {% else %}
                    Free
                    {% endif %}
                </span>
            </div>
            {% if cheat.price > 0 %}
            <button class="btn btn-buy" onclick="showBuyModal({{ cheat.id }}, '{{ cheat.name }}', '{{ cheat.game }}', {{ cheat.price }})">
                <i class="fas fa-shopping-cart"></i> Buy
            </button>
            {% else %}
            <button class="btn btn-buy" onclick="showFreeModal({{ cheat.id }}, '{{ cheat.name }}', '{{ cheat.game }}')">
                <i class="fas fa-gift"></i> Get Free
            </button>
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>


<div class="modal-overlay" id="buyModal">
    <div class="modal-content buy-modal">
        <button class="modal-close" onclick="closeBuyModal()">&times;</button>
        <h2>Buy <span id="buyCheatName"></span></h2>
        <p class="modal-subtitle">Choose payment method</p>
        
        <div class="payment-tabs">
            <button class="payment-tab active" onclick="switchPaymentTab('resellers')">
                <i class="fas fa-store"></i> Resellers
            </button>
            <button class="payment-tab" onclick="switchPaymentTab('coins')">
                <i class="fas fa-coins"></i> LC Coins
            </button>
        </div>
        
        
        <div class="payment-content" id="resellersTab">
            <div class="resellers-list-modal">
                {% for reseller in site_settings.resellers %}
                <a href="{{ reseller.link }}" target="_blank" class="reseller-btn">
                    {% if reseller.flag %}<span class="reseller-flag">{{ reseller.flag }}</span>{% endif %}
                    <span class="reseller-name">{{ reseller.name }}</span>
                    <i class="fas fa-external-link-alt"></i>
                </a>
                {% endfor %}
            </div>
            {% if not site_settings.resellers %}
            <p class="no-resellers">No resellers available at the moment</p>
            {% endif %}
        </div>
        
        
        <div class="payment-content" id="coinsTab" style="display:none;">
            <form method="POST" action="{{ url_for('buy_with_coins') }}" id="buyCoinsForm">
                <input type="hidden" name="cheat_id" id="buyCheatId">
                <div class="coins-info-box">
                    <div class="your-balance">
                        Your balance: <span class="balance-amount">{{ user.coins or 0 }} LC</span>
                    </div>
                </div>
                <div class="duration-options coins-duration">
                    <label class="duration-option">
                        <input type="radio" name="days" value="7" checked onchange="updateCoinPrice()">
                        <span class="duration-box">
                            <span class="duration-days">7</span>
                            <span class="duration-label">days</span>
                            <span class="duration-lc" id="lc7">-</span>
                        </span>
                    </label>
                    <label class="duration-option">
                        <input type="radio" name="days" value="14" onchange="updateCoinPrice()">
                        <span class="duration-box">
                            <span class="duration-days">14</span>
                            <span class="duration-label">days</span>
                            <span class="duration-lc" id="lc14">-</span>
                        </span>
                    </label>
                    <label class="duration-option">
                        <input type="radio" name="days" value="30" onchange="updateCoinPrice()">
                        <span class="duration-box">
                            <span class="duration-days">30</span>
                            <span class="duration-label">days</span>
                            <span class="duration-lc" id="lc30">-</span>
                        </span>
                    </label>
                    <label class="duration-option">
                        <input type="radio" name="days" value="90" onchange="updateCoinPrice()">
                        <span class="duration-box">
                            <span class="duration-days">90</span>
                            <span class="duration-label">days</span>
                            <span class="duration-lc" id="lc90">-</span>
                        </span>
                    </label>
                </div>
                <div class="total-price-box">
                    Total: <span id="totalLcPrice">0</span> LC
                </div>
                <button type="submit" class="btn btn-primary btn-full" style="margin-top:15px;">
                    <i class="fas fa-coins"></i> Buy with LC
                </button>
            </form>
        </div>
    </div>
</div>


<div class="modal-overlay" id="freeModal">
    <div class="modal-content buy-modal">
        <button class="modal-close" onclick="closeFreeModal()">&times;</button>
        <h2>Get <span id="freeCheatName"></span></h2>
        <p class="modal-subtitle">Select subscription duration</p>
        <form method="POST" action="{{ url_for('activate_free_cheat') }}" id="freeCheatForm">
            <input type="hidden" name="cheat_id" id="freeCheatId">
            <div class="duration-options">
                <label class="duration-option">
                    <input type="radio" name="days" value="7" checked>
                    <span class="duration-box">
                        <span class="duration-days">7</span>
                        <span class="duration-label">days</span>
                    </span>
                </label>
                <label class="duration-option">
                    <input type="radio" name="days" value="14">
                    <span class="duration-box">
                        <span class="duration-days">14</span>
                        <span class="duration-label">days</span>
                    </span>
                </label>
                <label class="duration-option">
                    <input type="radio" name="days" value="30">
                    <span class="duration-box">
                        <span class="duration-days">30</span>
                        <span class="duration-label">days</span>
                    </span>
                </label>
                <label class="duration-option">
                    <input type="radio" name="days" value="90">
                    <span class="duration-box">
                        <span class="duration-days">90</span>
                        <span class="duration-label">days</span>
                    </span>
                </label>
            </div>
            <button type="submit" class="btn btn-primary btn-full" style="margin-top:20px;">
                <i class="fas fa-check"></i> Activate
            </button>
        </form>
    </div>
</div>

<style>
.lc-price {
    display: block;
    font-size: 11px;
    color: #6366f1;
    margin-top: 2px;
}
.duration-options {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-top: 15px;
}
.duration-option input {
    display: none;
}
.duration-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px 10px;
    background: #1a1a1f;
    border: 2px solid #2a2a2f;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}
.duration-option input:checked + .duration-box {
    border-color: #6366f1;
    background: rgba(99, 102, 241, 0.1);
}
.duration-box:hover {
    border-color: #4a4a5f;
}
.duration-days {
    font-size: 24px;
    font-weight: bold;
    color: #fff;
}
.duration-label {
    font-size: 12px;
    color: #8a8a8f;
}
.duration-lc {
    font-size: 11px;
    color: #6366f1;
    margin-top: 4px;
}
.payment-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
.payment-tab {
    flex: 1;
    padding: 12px;
    background: #1a1a1f;
    border: 2px solid #2a2a2f;
    border-radius: 8px;
    color: #8a8a8f;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}
.payment-tab.active {
    border-color: #6366f1;
    color: #fff;
    background: rgba(99, 102, 241, 0.1);
}
.payment-tab:hover {
    border-color: #4a4a5f;
}
.payment-tab i {
    margin-right: 6px;
}
.coins-info-box {
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 15px;
    text-align: center;
}
.your-balance {
    color: #8a8a8f;
    font-size: 14px;
}
.balance-amount {
    color: #6366f1;
    font-weight: 600;
}
.total-price-box {
    background: #1a1a1f;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    font-size: 18px;
    color: #fff;
    margin-top: 15px;
}
.total-price-box span {
    color: #6366f1;
    font-weight: bold;
}
</style>

<script>
const COIN_RATE = {{ site_settings.coin_rate }};
let currentCheatPrice = 0;

function showBuyModal(cheatId, cheatName, cheatGame, price) {
    document.getElementById('buyCheatName').textContent = cheatName + ' (' + cheatGame + ')';
    document.getElementById('buyCheatId').value = cheatId;
    currentCheatPrice = price;
    updateCoinPrices();
    updateCoinPrice();
    switchPaymentTab('resellers');
    document.getElementById('buyModal').classList.add('show');
}

function closeBuyModal() {
    document.getElementById('buyModal').classList.remove('show');
}

function switchPaymentTab(tab) {
    document.querySelectorAll('.payment-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.payment-content').forEach(c => c.style.display = 'none');
    
    if (tab === 'resellers') {
        document.querySelector('.payment-tab:first-child').classList.add('active');
        document.getElementById('resellersTab').style.display = 'block';
    } else {
        document.querySelector('.payment-tab:last-child').classList.add('active');
        document.getElementById('coinsTab').style.display = 'block';
    }
}

function updateCoinPrices() {
    const pricePerDay = currentCheatPrice / 30;
    [7, 14, 30, 90].forEach(days => {
        const lc = Math.ceil(pricePerDay * days * COIN_RATE);
        document.getElementById('lc' + days).textContent = lc + ' LC';
    });
}

function updateCoinPrice() {
    const days = document.querySelector('#buyCoinsForm input[name="days"]:checked').value;
    const pricePerDay = currentCheatPrice / 30;
    const totalLc = Math.ceil(pricePerDay * days * COIN_RATE);
    document.getElementById('totalLcPrice').textContent = totalLc;
}

function showFreeModal(cheatId, cheatName, cheatGame) {
    document.getElementById('freeCheatName').textContent = cheatName + ' (' + cheatGame + ')';
    document.getElementById('freeCheatId').value = cheatId;
    document.getElementById('freeModal').classList.add('show');
}

function closeFreeModal() {
    document.getElementById('freeModal').classList.remove('show');
}

document.getElementById('buyModal').addEventListener('click', function(e) {
    if (e.target === this) closeBuyModal();
});

document.getElementById('freeModal').addEventListener('click', function(e) {
    if (e.target === this) closeFreeModal();
});
</script>
{% endblock %}
